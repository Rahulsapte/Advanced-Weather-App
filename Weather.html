<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Advanced Weather</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0;font-family:"Poppins",system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
  body{
    min-height:100vh;display:flex;align-items:center;justify-content:center;
    background:linear-gradient(120deg,#4facfe,#00f2fe);transition:background 1s ease;
  }
  .card{
    width:420px;max-width:94vw;padding:22px;border-radius:18px;
    background:rgba(255,255,255,0.12);backdrop-filter:blur(12px);
    box-shadow:0 10px 30px rgba(0,0,0,0.2);color:#fff;
  }
  h1{font-size:20px;margin-bottom:8px}
  .controls{display:flex;gap:8px;margin-top:10px}
  input{flex:1;padding:10px 12px;border-radius:10px;border:none;font-size:15px}
  button{padding:10px 14px;border-radius:10px;border:none;background:#0078ff;color:#fff;cursor:pointer;font-weight:600}
  button.alt{background:transparent;border:1px solid rgba(255,255,255,0.18)}
  .loader{display:none;margin:18px 0;text-align:center}
  .loader span{display:inline-block;width:10px;height:10px;margin:0 4px;background:#fff;border-radius:50%;animation:bounce .6s infinite alternate}
  .loader span:nth-child(2){animation-delay:.15s}
  .loader span:nth-child(3){animation-delay:.3s}
  @keyframes bounce{from{transform:translateY(0)}to{transform:translateY(-10px)}}

  .weather{display:none;margin-top:18px}
  .top{display:flex;align-items:center;gap:12px}
  .icon{width:100px;height:100px;flex-shrink:0}
  .now{flex:1}
  .temp{font-size:44px;font-weight:700;line-height:1}
  .desc{opacity:.95;margin-top:4px;font-size:16px}
  .meta{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
  .meta div{background:rgba(255,255,255,0.06);padding:8px 10px;border-radius:10px;font-size:14px}

  .forecast{display:flex;gap:8px;margin-top:16px;overflow:auto;padding-bottom:6px}
  .day{min-width:78px;background:rgba(255,255,255,0.06);border-radius:10px;padding:8px;text-align:center;font-size:13px}
  .day .dtemp{font-weight:700;margin-top:6px}

  footer{margin-top:12px;font-size:12px;opacity:.9}
  a{color:inherit;text-decoration:underline}
</style>
</head>
<body>
  <div class="card" id="card">
    <h1>Advanced Weather — (No API Key)</h1>
    <div style="font-size:13px;opacity:.95">Search any city or use your device location. Data from <strong>Open-Meteo</strong> + <strong>OpenStreetMap</strong>.</div>

    <div class="controls">
      <input id="cityInput" placeholder="Enter city (e.g., New York, Mumbai)" />
      <button id="searchBtn">Search</button>
      <button id="locBtn" class="alt">Use My Location</button>
    </div>

    <div class="loader" id="loader"><span></span><span></span><span></span></div>

    <div class="weather" id="weather">
      <div class="top">
        <img id="wicon" class="icon" src="" alt="icon" />
        <div class="now">
          <div class="temp" id="temp">--°C</div>
          <div class="desc" id="desc">--</div>
          <div style="font-size:13px;margin-top:6px" id="place">—</div>
        </div>
      </div>

      <div class="meta" id="meta">
        <!-- dynamically filled -->
      </div>

      <div class="forecast" id="forecast">
        <!-- 5-day forecast -->
      </div>

      <footer style="margin-top:12px">
        Data sources: <a href="https://open-meteo.com" target="_blank">Open-Meteo</a>, <a href="https://nominatim.org" target="_blank">Nominatim</a>
      </footer>
    </div>
  </div>

<script>
/*
  How it works:
  - For a city search: geocode via Nominatim → lat/lon
  - For current weather & 7-day forecast: Open-Meteo (no key)
  - UI: current weather + extra info + 5-day daily forecast
*/

const searchBtn = document.getElementById('searchBtn');
const locBtn = document.getElementById('locBtn');
const cityInput = document.getElementById('cityInput');
const loader = document.getElementById('loader');
const weatherEl = document.getElementById('weather');
const tempEl = document.getElementById('temp');
const descEl = document.getElementById('desc');
const placeEl = document.getElementById('place');
const metaEl = document.getElementById('meta');
const forecastEl = document.getElementById('forecast');
const wicon = document.getElementById('wicon');
const card = document.getElementById('card');

searchBtn.addEventListener('click', () => {
  const q = cityInput.value.trim();
  if (!q) return alert('Please type a city name.');
  startLoading();
  geocodeCity(q).then(coords => {
    if (!coords) { stopLoading(); alert('City not found.'); return; }
    fetchWeather(coords.lat, coords.lon, coords.display_name);
  }).catch(err => { stopLoading(); alert('Error fetching location.'); console.error(err); });
});

locBtn.addEventListener('click', () => {
  if (!navigator.geolocation) return alert('Geolocation not supported by your browser.');
  startLoading();
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude, lon = pos.coords.longitude;
    fetchReverseGeocode(lat, lon).then(place => {
      fetchWeather(lat, lon, place || 'Your Location');
    }).catch(err => {
      fetchWeather(lat, lon, 'Your Location');
    });
  }, err => {
    stopLoading();
    alert('Location permission denied or unavailable.');
  });
});

/* --- Helpers --- */

function startLoading(){
  loader.style.display='block';
  weatherEl.style.display='none';
}
function stopLoading(){
  loader.style.display='none';
}

/* --- Nominatim geocoding --- */
async function geocodeCity(q){
  const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
  const res = await fetch(url, { headers: { 'Accept-Language': 'en' } });
  if(!res.ok) return null;
  const arr = await res.json();
  if(!arr || arr.length===0) return null;
  return { lat: arr[0].lat, lon: arr[0].lon, display_name: arr[0].display_name };
}

async function fetchReverseGeocode(lat, lon){
  const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`;
  const res = await fetch(url);
  if(!res.ok) return null;
  const js = await res.json();
  return js.display_name || null;
}

/* --- Open-Meteo fetch --- */
async function fetchWeather(lat, lon, placeName){
  try {
    // Open-Meteo endpoint: current_weather + daily forecast + hourly humidity + sunrise/sunset etc
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}`
      + `&current_weather=true&daily=temperature_2m_max,temperature_2m_min,weathercode,sunrise,sunset`
      + `&hourly=relativehumidity_2m,apparent_temperature,visibility`
      + `&timezone=auto`;

    const res = await fetch(url);
    if(!res.ok) { stopLoading(); alert('Weather fetch failed'); return; }
    const data = await res.json();
    stopLoading();

    // Current weather from API
    const cur = data.current_weather || {};
    const cwTemp = cur.temperature;              // °C
    const cwWcode = cur.weathercode;             // numeric code
    const cwWind = cur.windspeed;                // m/s (Open-Meteo returns m/s)
    const timezone = data.timezone;

    // Some extra values (closest hourly index)
    const nowISO = new Date().toISOString().slice(0,19); // quick reference (not perfectly aligned)
    // We'll take hourly index 0 as approximation since current_weather gives current values
    const hourly = data.hourly || {};
    const humidity = hourly.relativehumidity_2m ? hourly.relativehumidity_2m[0] : '—';
    const apparent = hourly.apparent_temperature ? hourly.apparent_temperature[0] : '—';
    const visibility = hourly.visibility ? (hourly.visibility[0]/1000).toFixed(1) : '—'; // km

    // Daily forecast array (dates, max, min, weathercode)
    const daily = data.daily || {};

    // Update UI
    tempEl.textContent = `${Math.round(cwTemp)}°C`;
    const wc = mapWeatherCode(cwWcode);
    descEl.textContent = `${wc.text}`;
    placeEl.textContent = placeName || '—';

    // icon
    wicon.src = wc.icon;
    wicon.alt = wc.text;

    // meta info
    metaEl.innerHTML = `
      <div>Feels: ${Math.round(apparent)}°C</div>
      <div>Wind: ${Math.round(cwWind)} m/s</div>
      <div>Humidity: ${humidity}%</div>
      <div>Visibility: ${visibility} km</div>
      <div>Sunrise: ${formatTime(daily.sunrise ? daily.sunrise[0] : null)}</div>
      <div>Sunset: ${formatTime(daily.sunset ? daily.sunset[0] : null)}</div>
    `;

    // Forecast (next 5 days)
    let fhtml = '';
    if(daily.time && daily.time.length){
      for(let i=0;i<Math.min(5,daily.time.length);i++){
        const d = daily.time[i];
        const max = Math.round(daily.temperature_2m_max[i]);
        const min = Math.round(daily.temperature_2m_min[i]);
        const code = daily.weathercode[i];
        const m = mapWeatherCode(code);
        fhtml += `
          <div class="day">
            <div style="font-weight:600">${formatDateShort(d)}</div>
            <img src="${m.icon}" style="width:44px;height:44px;margin-top:6px" alt="${m.text}" />
            <div class="dtemp">${max}° / ${min}°</div>
            <div style="opacity:.9;font-size:12px;margin-top:4px">${m.text}</div>
          </div>
        `;
      }
    }
    forecastEl.innerHTML = fhtml;

    // background change approx by main code (clear/cloud/rain/snow)
    applyBackgroundByCode(cwWcode);

    weatherEl.style.display = 'block';
    // scroll weather into view if mobile
    weatherEl.scrollIntoView({behavior:'smooth', block:'nearest'});

  } catch(err) {
    stopLoading();
    console.error(err);
    alert('Error retrieving weather data.');
  }
}

/* --- Utilities --- */
function formatTime(iso){
  if(!iso) return '—';
  try {
    const d = new Date(iso);
    return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
  } catch { return iso; }
}
function formatDateShort(iso){
  const d = new Date(iso);
  return d.toLocaleDateString(undefined, {weekday:'short', month:'short', day:'numeric'});
}

/* Map Open-Meteo weather codes to text & icons
   (simplified mapping + using open-source icon sprites hosted via raw.githubusercontent)
   We will use simple SVG URLs embedded as data URI or use public icons (small PNGs).
*/
function mapWeatherCode(code){
  // tiny local SVG generator for few conditions (data URIs) for crisp look
  if(code === 0) return {text:'Clear', icon: sunnySVG()};
  if(code === 1 || code === 2) return {text:'Partly Cloudy', icon: partlyCloudySVG()};
  if(code === 3) return {text:'Cloudy', icon: cloudySVG()};
  if(code >= 45 && code <= 48) return {text:'Fog', icon: fogSVG()};
  if((code>=51 && code<=67) || (code>=80 && code<=82)) return {text:'Rain', icon: rainSVG()};
  if((code>=71 && code<=77) || (code>=85 && code<=86)) return {text:'Snow', icon: snowSVG()};
  if(code>=95 && code<=99) return {text:'Thunderstorm', icon: thunderSVG()};
  return {text:'Weather', icon: partlyCloudySVG()};
}

/* Background visuals by code group */
function applyBackgroundByCode(code){
  let bg;
  if(code === 0) bg='linear-gradient(120deg,#fceabb,#f8b500)';         // clear
  else if(code<=3) bg='linear-gradient(120deg,#89f7fe,#66a6ff)';      // partly/cloudy
  else if((code>=45 && code<=48)) bg='linear-gradient(120deg,#3e5151,#decba4)'; // fog
  else if((code>=51 && code<=67) || (code>=80 && code<=82)) bg='linear-gradient(120deg,#4b79a1,#283e51)'; // rain
  else if((code>=71 && code<=77) || (code>=85 && code<=86)) bg='linear-gradient(120deg,#e6dada,#274046)'; // snow
  else if(code>=95) bg='linear-gradient(120deg,#373b44,#4286f4)'; // thunder
  else bg='linear-gradient(120deg,#4facfe,#00f2fe)';
  document.body.style.background = bg;
}

/* --- Simple SVG icon generators (data URIs) --- */
function svgToDataUri(svg){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg); }

function sunnySVG(){ return svgToDataUri(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><circle cx='32' cy='32' r='12' fill='#FFD24D'/></svg>`); }
function partlyCloudySVG(){ return svgToDataUri(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><g><circle cx='22' cy='22' r='8' fill='#FFD24D'/><path d='M10 38a15 15 0 0 1 30 0H10z' fill='#E6EEF3'/></g></svg>`); }
function cloudySVG(){ return svgToDataUri(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path d='M8 36a14 14 0 0 1 28 0H8z' fill='#E6EEF3'/></svg>`); }
function rainSVG(){ return svgToDataUri(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path d='M8 28a14 14 0 0 1 28 0H8z' fill='#E6EEF3'/><g fill='#70BFFF'><path d='M20 46c0 3-4 6-4 6s-4-3-4-6 4-6 4-6 4 3 4 6zM36 46c0 3-4 6-4 6s-4-3-4-6 4-6 4-6 4 3 4 6z'/></g></svg>`); }
function snowSVG(){ return svgToDataUri(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path d='M8 28a14 14 0 0 1 28 0H8z' fill='#E6EEF3'/><g fill='#FFFFFF'><text x='18' y='46' font-size='22'>❄</text></g></svg>`); }
function fogSVG(){ return svgToDataUri(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect x='8' y='20' width='48' height='8' rx='4' fill='#E6EEF3' /><rect x='8' y='34' width='48' height='6' rx='3' fill='#E6EEF3' /></svg>`); }
function thunderSVG(){ return svgToDataUri(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><path d='M12 28a12 12 0 1 1 24 0H12z' fill='#E6EEF3'/><path d='M28 36 L22 50 L34 44 L26 64 L40 44 L34 48 Z' fill='#FFD24D'/></svg>`); }

</script>
</body>
</html>

